
# [1] ë„êµ¬ ìƒì ì¤€ë¹„í•˜ê¸°
import os  # ì»´í“¨í„°ì˜ í´ë”ë‚˜ íŒŒì¼ì„ ë‹¤ë£¨ëŠ” ë„êµ¬ ìƒìë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
import random  # ì œë¹„ë½‘ê¸°ì²˜ëŸ¼ ë¬´ì‘ìœ„ë¡œ ë­”ê°€ë¥¼ ë½‘ëŠ” ë„êµ¬ ìƒìë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
from datetime import datetime  # ë‚ ì§œì™€ ì‹œê°„ì„ ë‹¤ë£¨ëŠ” ë„êµ¬ ìƒìì—ì„œ 'datetime'ì´ë¼ëŠ” ë„êµ¬ë§Œ ì™ ë¹¼ì˜µë‹ˆë‹¤.

# ==========================================
# [1] ì„¤ì • ë° ì´ˆê¸°í™” (ì¬ë£Œ ì¤€ë¹„)
# ==========================================
# 'BASE_DIR'ì´ë¼ëŠ” ì´ë¦„í‘œë¥¼ ë¶™ì¸ ìƒìì— "logs"ë¼ëŠ” ê¸€ìë¥¼ ë‹´ì•„ë‘¡ë‹ˆë‹¤. (í´ë” ì´ë¦„ìœ¼ë¡œ ì“¸ ê±°ì˜ˆìš”)
BASE_DIR = "logs"

# 'LOG_FILENAME'ì´ë¼ëŠ” ìƒìì— íŒŒì¼ ì´ë¦„ì„ ë‹´ì•„ë‘¡ë‹ˆë‹¤.
LOG_FILENAME = "server_access.log"
# 'REPORT_FILENAME'ì´ë¼ëŠ” ìƒìì— ê²°ê³¼ ë³´ê³ ì„œ íŒŒì¼ ì´ë¦„ì„ ë‹´ì•„ë‘¡ë‹ˆë‹¤.
REPORT_FILENAME = "analysis_result.txt"

# ì»´í“¨í„°ê°€ ì•Œì•„ë“¤ì„ ìˆ˜ ìˆëŠ” ì§„ì§œ íŒŒì¼ ê²½ë¡œë¥¼ ë§Œë“­ë‹ˆë‹¤.
# os.path.joinì€ "logs" í´ë” ì•ˆì— "server_access.log" íŒŒì¼ì´ ìˆë‹¤ê³  ì£¼ì†Œë¥¼ í•©ì³ì£¼ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.
FILE_PATH = os.path.join(BASE_DIR, LOG_FILENAME)
REPORT_PATH = os.path.join(BASE_DIR, REPORT_FILENAME)

# ==========================================
# [2] ê°€ì§œ ë°ì´í„° ë§Œë“¤ê¸° (í…ŒìŠ¤íŠ¸ìš©)
# ==========================================
# 'generate_dummy_log'ë¼ëŠ” ì´ë¦„ì˜ ì‘ì—… ëª…ë ¹ì„œ(í•¨ìˆ˜)ë¥¼ ë§Œë“­ë‹ˆë‹¤.
# ë‚˜ì¤‘ì— ì´ ì´ë¦„ì„ ë¶€ë¥´ë©´ ì•„ë˜ ë“¤ì—¬ì“°ê¸° ëœ ë‚´ìš©ë“¤ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.
def generate_dummy_log():
    
    # ë§Œì•½(if) "logs"ë¼ëŠ” í´ë”ê°€ ì—†ë‹¤ë©´(not exists)...
    if not os.path.exists(BASE_DIR):
        os.makedirs(BASE_DIR) # ê·¸ í´ë”ë¥¼ ìƒˆë¡œ ë§Œë“¤ì–´ë¼!

    # ë§Œì•½(if) ì´ë¯¸ ë¡œê·¸ íŒŒì¼ì´ ìˆë‹¤ë©´...
    if os.path.exists(FILE_PATH):
        print(f"[System] ê¸°ì¡´ ë¡œê·¸ íŒŒì¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤: {FILE_PATH}") # í™”ë©´ì— ê¸€ìë¥¼ ì¶œë ¥í•˜ê³ 
        return # ë” ì´ìƒ í•  ì¼ ì—†ìœ¼ë‹ˆ ì—¬ê¸°ì„œ ì‘ì—…ì„ ëë‚¸ë‹¤.

    print("[System] í…ŒìŠ¤íŠ¸ìš© ë¡œê·¸ íŒŒì¼ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...")
    
    # ëœë¤ìœ¼ë¡œ ë½‘ì„ ì¬ë£Œë“¤ì„ ë¦¬ìŠ¤íŠ¸(ëª©ë¡)ë¡œ ë§Œë“­ë‹ˆë‹¤.
    log_levels = ["INFO", "WARNING", "ERROR", "DEBUG"] # ë¡œê·¸ ë“±ê¸‰ ëª©ë¡
    messages = [ # ë°œìƒí•  ìˆ˜ ìˆëŠ” ë©”ì‹œì§€ ëª©ë¡
        "User login successful",
        "Database connection failed",
        "Page load timeout",
        "Image upload complete",
        "Payment processing error",
        "Admin logout"
    ]
    
    # ê°€ìƒì˜ IP ì£¼ì†Œ ëª©ë¡ì…ë‹ˆë‹¤.
    ips = ["192.168.0.1", "10.0.0.5", "172.16.254.1", "127.0.0.1", "192.168.0.1"]

    # 'open'ì€ íŒŒì¼ì„ ì—¬ëŠ” ëª…ë ¹ì–´ì…ë‹ˆë‹¤. 
    # "w"ëŠ” Write(ì“°ê¸°) ëª¨ë“œì…ë‹ˆë‹¤. ì¦‰, ìƒˆ ì¢…ì´ë¥¼ êº¼ë‚´ëŠ” ê²ƒê³¼ ê°™ìŠµë‹ˆë‹¤.
    # 'as f'ëŠ” ì´ íŒŒì¼ì„ ì ê¹ 'f'ë¼ê³  ë¶€ë¥´ê² ë‹¤ëŠ” ëœ»ì…ë‹ˆë‹¤.
    with open(FILE_PATH, "w", encoding="utf-8") as f:
        # 100ë²ˆ ë°˜ë³µí•´ë¼ (range(100))
        for _ in range(100):
            # í˜„ì¬ ì‹œê°„ì„ ê°€ì ¸ì™€ì„œ "ë…„-ì›”-ì¼ ì‹œ:ë¶„:ì´ˆ" ëª¨ì–‘ì˜ ê¸€ìë¡œ ë°”ê¿‰ë‹ˆë‹¤.
            date_str = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            
            # ì•„ê¹Œ ë§Œë“  ëª©ë¡ì—ì„œ ëœë¤ìœ¼ë¡œ í•˜ë‚˜ì”©(choice) ë½‘ìŠµë‹ˆë‹¤.
            level = random.choice(log_levels) # ë“±ê¸‰ ë½‘ê¸°
            msg = random.choice(messages)     # ë©”ì‹œì§€ ë½‘ê¸°
            ip = random.choice(ips)           # IP ë½‘ê¸°
            
            # ë½‘ì€ ì¬ë£Œë“¤ì„ ì¡°ë¦½í•´ì„œ í•œ ë¬¸ì¥ìœ¼ë¡œ ë§Œë“­ë‹ˆë‹¤.
            # f"..." ì•ˆì— {ë³€ìˆ˜}ë¥¼ ë„£ìœ¼ë©´ ê·¸ ë‚´ìš©ì´ ë¬¸ì¥ ì†ì— ì™ ë“¤ì–´ê°‘ë‹ˆë‹¤.
            # \nì€ 'ì—”í„°í‚¤(ì¤„ë°”ê¿ˆ)'ë¥¼ ì¹˜ë¼ëŠ” ëœ»ì…ë‹ˆë‹¤.
            log_line = f"[{date_str}] {level} - {msg} (IP:{ip})\n"
            
            # íŒŒì¼(f)ì— ì´ ë¬¸ì¥ì„ ì ìŠµë‹ˆë‹¤.
            f.write(log_line)
            
    print("[System] ë¡œê·¸ íŒŒì¼ ìƒì„± ì™„ë£Œ!") # ì‘ì—…ì´ ë‹¤ ëë‚˜ë©´ ì¶œë ¥

# ==========================================
# [3] ë°ì´í„°ë¥¼ ì½ì–´ì„œ ë¶„ì„í•˜ê¸° (í•µì‹¬ ì‘ì—…)
# ==========================================
# 'parse_logs'ë¼ëŠ” ì‘ì—… ëª…ë ¹ì„œ(í•¨ìˆ˜)ë¥¼ ë§Œë“­ë‹ˆë‹¤.
# ì´ ì‘ì—…ì€ íŒŒì¼ ê²½ë¡œ(file_path)ë¥¼ ì¬ë£Œë¡œ ë°›ì•„ì„œ ì‹¤í–‰í•©ë‹ˆë‹¤.
def parse_logs(file_path):
    
    parsed_data = [] # ì •ë¦¬ëœ ë°ì´í„°ë¥¼ ë‹´ì„ ë¹ˆ ë°”êµ¬ë‹ˆ(ë¦¬ìŠ¤íŠ¸)ë¥¼ ì¤€ë¹„í•©ë‹ˆë‹¤.
    
    print(f"\n[Analysis] '{file_path}' íŒŒì¼ì„ ë¶„ì„í•©ë‹ˆë‹¤...")

    try: # "ì¼ë‹¨ ì‹œë„í•´ë´!" (ì—ëŸ¬ê°€ ë‚  ìˆ˜ë„ ìˆìœ¼ë‹ˆê¹Œ ì•ˆì „ì¥ì¹˜ë¥¼ ê±°ëŠ” ê²ƒ)
        # íŒŒì¼ì„ ì½ê¸° ì „ìš©("r" -> Read)ìœ¼ë¡œ ì—½ë‹ˆë‹¤.
        with open(file_path, "r", encoding="utf-8") as file:
            lines = file.readlines() # íŒŒì¼ì— ìˆëŠ” ëª¨ë“  ì¤„ì„ í•œë²ˆì— ì½ì–´ì˜µë‹ˆë‹¤.
            
            # ì½ì–´ì˜¨ ì¤„ì„ í•˜ë‚˜ì”© êº¼ë‚´ì„œ ë°˜ë³µí•©ë‹ˆë‹¤.
            for line in lines:
                line = line.strip() # ë¬¸ì¥ ì•ë’¤ì— ìˆëŠ” ê³µë°±ì´ë‚˜ ì¤„ë°”ê¿ˆ ê¸°í˜¸ë¥¼ ê¹¨ë—ì´ ì§€ì›ë‹ˆë‹¤.
                if not line: # ë§Œì•½ ë‚´ìš©ì´ ì—†ëŠ” ë¹ˆ ì¤„ì´ë¼ë©´?
                    continue # ë¬´ì‹œí•˜ê³  ë‹¤ìŒ ì¤„ë¡œ ë„˜ì–´ê°€ë¼.
                
                # --- ê¸€ì ìë¥´ê¸° (ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„) ---
                # ëª©í‘œ: "[ë‚ ì§œ] ë ˆë²¨ - ë©”ì‹œì§€" í˜•íƒœë¥¼ ë¶„í•´í•˜ê¸°
                
                try: # ë˜ ì•ˆì „ì¥ì¹˜ (ê¸€ì ëª¨ì–‘ì´ ì´ìƒí• ê¹Œë´)
                    # " - "ë¼ëŠ” ê¸€ìë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¬¸ì¥ì„ ë‘ ë™ê°• ëƒ…ë‹ˆë‹¤.
                    split_parts = line.split(" - ") 
                    prefix = split_parts[0]        # ì•ë™ê°• (ë‚ ì§œì™€ ë ˆë²¨)
                    message_part = split_parts[1]  # ë’·ë™ê°• (ë©”ì‹œì§€ì™€ IP)
                    
                    # ë ˆë²¨ë§Œ ì™ ë½‘ê¸°: "] " ë’¤ì— ìˆëŠ” ê¸€ìë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
                    level = prefix.split("] ")[1] 
                    
                    # IP ì£¼ì†Œ ë½‘ê¸°
                    # "(IP:" ë¼ëŠ” ê¸€ìê°€ ëª‡ ë²ˆì§¸ ì¹¸ì— ìˆëŠ”ì§€ ì°¾ê³ , 4ì¹¸ ë’¤ë¡œ ê°‘ë‹ˆë‹¤.
                    ip_start = message_part.find("(IP:") + 4
                    # ")" ê¸€ìê°€ ëª‡ ë²ˆì§¸ ì¹¸ì— ìˆëŠ”ì§€ ì°¾ìŠµë‹ˆë‹¤.
                    ip_end = message_part.find(")")
                    # ì‹œì‘ ìœ„ì¹˜ë¶€í„° ë ìœ„ì¹˜ ì „ê¹Œì§€ ê¸€ìë¥¼ ì˜¤ë ¤ëƒ…ë‹ˆë‹¤.
                    ip_address = message_part[ip_start:ip_end]

                    # ì •ë¦¬í•œ ì •ë³´ë¥¼ ë¬¶ìŒ(ë”•ì…”ë„ˆë¦¬)ìœ¼ë¡œ ë§Œë“¤ì–´ì„œ ë°”êµ¬ë‹ˆ(parsed_data)ì— ë‹´ìŠµë‹ˆë‹¤.
                    parsed_data.append({
                        "level": level,    # ì¶”ì¶œí•œ ë ˆë²¨
                        "ip": ip_address,  # ì¶”ì¶œí•œ IP
                        "raw": line        # ì›ë³¸ ë¬¸ì¥
                    })

                except IndexError:
                    # ê¸€ì ìë¥´ë‹¤ê°€ ì‹¤íŒ¨í•˜ë©´ ê·¸ëƒ¥ ë‹¤ìŒ ì¤„ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.
                    continue
                    
    except FileNotFoundError:
        # ë§Œì•½ íŒŒì¼ì´ ì—†ì–´ì„œ ì—ëŸ¬ê°€ ë‚˜ë©´ ì´ ë©”ì‹œì§€ë¥¼ ë„ì›ë‹ˆë‹¤.
        print("[Error] ë¡œê·¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return [] # ë¹ˆ ë°”êµ¬ë‹ˆë¥¼ ì£¼ê³  ëëƒ…ë‹ˆë‹¤.

    print(f"[Analysis] ì´ {len(parsed_data)}ì¤„ì˜ ë¡œê·¸ë¥¼ ì½ì–´ì™”ìŠµë‹ˆë‹¤.")
    return parsed_data # ê½‰ ì±„ìš´ ë°”êµ¬ë‹ˆë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

# í†µê³„ë¥¼ ë‚´ëŠ” ì‘ì—… ëª…ë ¹ì„œì…ë‹ˆë‹¤.
def calculate_statistics(data):
    
    level_counts = {}  # ë ˆë²¨ë³„ ê°œìˆ˜ë¥¼ ì…€ ìˆ˜ì²© (ë”•ì…”ë„ˆë¦¬)
    ip_counts = {}     # IPë³„ ê°œìˆ˜ë¥¼ ì…€ ìˆ˜ì²©
    
    # ì •ë¦¬ëœ ë°ì´í„° ë°”êµ¬ë‹ˆì—ì„œ í•˜ë‚˜ì”© êº¼ë‚´ë´…ë‹ˆë‹¤.
    for entry in data:
        lvl = entry["level"] # ë ˆë²¨ í™•ì¸
        ip = entry["ip"]     # IP í™•ì¸
        
        # 1. ë ˆë²¨ ê°œìˆ˜ ì„¸ê¸°
        if lvl in level_counts: # ìˆ˜ì²©ì— ì´ë¯¸ ì í˜€ìˆëŠ” ë ˆë²¨ì´ë©´?
            level_counts[lvl] += 1 # ê°œìˆ˜ë¥¼ í•˜ë‚˜ ëŠ˜ë¦°ë‹¤.
        else: # ì²˜ìŒ ë³´ëŠ” ë ˆë²¨ì´ë©´?
            level_counts[lvl] = 1  # ê°œìˆ˜ë¥¼ 1ë¡œ ì ëŠ”ë‹¤.
            
        # 2. IP ê°œìˆ˜ ì„¸ê¸° (ì¡°ê¸ˆ ë” ì„¸ë ¨ëœ ë°©ë²•)
        # ìˆ˜ì²©ì—ì„œ ipë¥¼ ì°¾ëŠ”ë°, ì—†ìœ¼ë©´ 0ì„ ê°€ì ¸ì˜¤ê³ , ê±°ê¸°ë‹¤ 1ì„ ë”í•´ë¼.
        ip_counts[ip] = ip_counts.get(ip, 0) + 1
        
    return level_counts, ip_counts # ì‘ì„±ëœ ë‘ ê°œì˜ ìˆ˜ì²©ì„ ëŒë ¤ì¤ë‹ˆë‹¤.

# ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì €ì¥í•˜ëŠ” ì‘ì—… ëª…ë ¹ì„œì…ë‹ˆë‹¤.
def save_report(level_counts, ip_counts):
    
    try:
        # ë³´ê³ ì„œ íŒŒì¼ì„ ì“°ê¸° ëª¨ë“œ("w")ë¡œ ì—½ë‹ˆë‹¤.
        with open(REPORT_PATH, "w", encoding="utf-8") as f:
            f.write("===== [ ì„œë²„ ë¡œê·¸ ë¶„ì„ ë³´ê³ ì„œ ] =====\n\n")
            
            f.write("1. ë¡œê·¸ ë ˆë²¨ë³„ ë°œìƒ í˜„í™©\n")
            f.write("-" * 30 + "\n") # ë¹¼ê¸°(-) ê¸°í˜¸ë¥¼ 30ê°œ ê·¸ë ¤ì„œ ì„ ì„ ê¸‹ìŠµë‹ˆë‹¤.
            
            # ë ˆë²¨ ìˆ˜ì²©ì— ì íŒ ë‚´ìš©ì„ í•˜ë‚˜ì”© êº¼ëƒ…ë‹ˆë‹¤. (ì´ë¦„ê³¼ ê°œìˆ˜)
            for lvl, count in level_counts.items():
                # ì¤„ì„ ì˜ˆì˜ê²Œ ë§ì¶”ê¸° ìœ„í•´ ì¹¸ì„ ì¡°ì ˆí•´ì„œ ì ìŠµë‹ˆë‹¤.
                f.write(f"- {lvl:<10} : {count}íšŒ\n")
            f.write("\n")
            
            f.write("2. ì ‘ì† ë¹ˆë„ ìƒìœ„ IP (Top 3)\n")
            f.write("-" * 30 + "\n")
            
            # --- ìˆœì„œëŒ€ë¡œ ì¤„ ì„¸ìš°ê¸° ---
            # ë°©ë¬¸ íšŸìˆ˜(x[1])ê°€ ë§ì€ ìˆœì„œ(reverse=True)ëŒ€ë¡œ ì •ë ¬í•©ë‹ˆë‹¤.
            sorted_ips = sorted(ip_counts.items(), key=lambda x: x[1], reverse=True)
            
            # 1ë“±ë¶€í„° 3ë“±ê¹Œì§€ë§Œ([:3]) ì˜ë¼ì„œ ì ìŠµë‹ˆë‹¤.
            for ip, count in sorted_ips[:3]:
                f.write(f"- {ip:<15} : {count}íšŒ ë°©ë¬¸\n")
                
        print(f"âœ… ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ: {REPORT_PATH}")
        
        # ì €ì¥ëœ ë‚´ìš©ì„ ìš°ë¦¬ê°€ ë³¼ ìˆ˜ ìˆê²Œ í™”ë©´ì—ë„ í•œë²ˆ ì¶œë ¥í•´ì¤ë‹ˆë‹¤.
        with open(REPORT_PATH, 'r', encoding='utf-8') as f:
            print(f.read())
            
    except Exception as e:
        # í˜¹ì‹œë¼ë„ ì €ì¥í•˜ë‹¤ ì—ëŸ¬ê°€ ë‚˜ë©´ ì›ì¸ì„ ì•Œë ¤ì¤ë‹ˆë‹¤.
        print(f"[Error] ë³´ê³ ì„œ ì €ì¥ ì‹¤íŒ¨: {e}")

# ==========================================
# [4] ì§„ì§œ ì‹œì‘í•˜ëŠ” ê³³ (Main)
# ==========================================
# ì´ íŒŒì¼ì´ ì‹¤í–‰ë˜ë©´ ì—¬ê¸°ì„œë¶€í„° ì‘ë™ì´ ì‹œì‘ë©ë‹ˆë‹¤. (ì‹œì‘ ë²„íŠ¼ ê°™ì€ ì¡´ì¬)
if __name__ == "__main__":
    print("ğŸš€ ë¡œê·¸ ë¶„ì„ ì‹œìŠ¤í…œ ê°€ë™ ì‹œì‘...")
    
    # 1. ìœ„ì—ì„œ ë§Œë“  'ê°€ì§œ ë°ì´í„° ë§Œë“¤ê¸°' ëª…ë ¹ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
    generate_dummy_log()
    
    # 2. 'ë°ì´í„° ì½ì–´ì„œ ë¶„ì„í•˜ê¸°' ëª…ë ¹ì„ ì‹¤í–‰í•˜ê³ , ê²°ê³¼ë¥¼ 'log_data'ì— ë‹´ìŠµë‹ˆë‹¤.
    log_data = parse_logs(FILE_PATH)
    
    # 3. ë§Œì•½ ë°ì´í„°ê°€ ë¹„ì–´ìˆì§€ ì•Šë‹¤ë©´(ë‚´ìš©ì´ ìˆë‹¤ë©´)?
    if log_data:
        # 'í†µê³„ ë‚´ê¸°' ëª…ë ¹ì„ ì‹¤í–‰í•´ì„œ ê²°ê³¼ë¥¼ ë°›ìŠµë‹ˆë‹¤.
        lvl_stat, ip_stat = calculate_statistics(log_data)
        
        # 4. 'ë³´ê³ ì„œ ì €ì¥í•˜ê¸°' ëª…ë ¹ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
        save_report(lvl_stat, ip_stat)
        
    print("\nğŸ í”„ë¡œê·¸ë¨ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")